#!/bin/bash

##############################################
# oSaint — UNIX OSINT Tool
##############################################

# ===== COLORS =====
RED="\e[31m"; GREEN="\e[32m"; YELLOW="\e[33m"
BLUE="\e[34m"; PURPLE="\e[35m"; CYAN="\e[36m"; NC="\e[0m"

# ===== ASCII =====
clear
cat << "EOF"
      (                           
      )\ )                     )  
     (()/(    )  (          ( /(  
  (   /(_))( /(  )\   (     )\()) 
  )\ (_))  )(_))((_)  )\ ) (_))/  
 ((_)/ __|((_)_  (_) _(_/( | |_   
/ _ \\__ \/ _` | | || ' \))|  _|  
\___/|___/\__,_| |_||_||_|  \__|  
                                  
EOF

echo -e "${PURPLE}────────────────────────────────────────${NC}"
echo -e "${CYAN}         oSaint - UNIX OSINT Tool"
echo -e "${PURPLE}────────────────────────────────────────${NC}"

# ===== Detect package manager =====
detect_pm() {
    if command -v apt >/dev/null; then PM="apt"
    elif command -v pacman >/dev/null; then PM="pacman"
    elif command -v dnf >/dev/null; then PM="dnf"
    elif command -v zypper >/dev/null; then PM="zypper"
    elif command -v apk >/dev/null; then PM="apk"
    elif command -v xbps-install >/dev/null; then PM="xbps"
    else PM="none"
    fi
}
detect_pm

# ===== UNIVERSAL INSTALLER =====
install_tool() {
    TOOL="$1"
    GITURL="$2"
    FALLBACK="$3"

    echo -e "${YELLOW}[!] Installing missing tool: ${TOOL}${NC}"

    case "$PM" in
        apt) sudo apt update && sudo apt install -y "$TOOL" && return ;;
        pacman) sudo pacman -S --noconfirm "$TOOL" && return ;;
        dnf) sudo dnf install -y "$TOOL" && return ;;
        zypper) sudo zypper install -y "$TOOL" && return ;;
        apk) sudo apk add "$TOOL" && return ;;
        xbps) sudo xbps-install -Sy "$TOOL" && return ;;
    esac

    # Git fallback
    if [ -n "$GITURL" ]; then
        echo -e "${BLUE}[+] Cloning from GitHub...${NC}"
        git clone "$GITURL" "/tmp/$TOOL" 2>/dev/null
        if [ -f "/tmp/$TOOL/$FALLBACK" ]; then
            sudo cp "/tmp/$TOOL/$FALLBACK" /usr/local/bin/$TOOL
            sudo chmod +x /usr/local/bin/$TOOL
            return
        fi
    fi

    echo -e "${RED}[x] Could not install $TOOL automatically.${NC}"
}

# ===== REQUIRE WRAPPER =====
require() {
    TOOL="$1"
    GIT="$2"
    FILE="$3"
    if ! command -v "$TOOL" >/dev/null; then
        install_tool "$TOOL" "$GIT" "$FILE"
    fi
}

##############################################
#                PASSIVE MODE
##############################################
passive() {
    QUERY="$1"
    echo -e "${CYAN}[PASSIVE OSINT] Query: $QUERY ${NC}"

    require "curl"
    require "jq"

    echo -e "${BLUE}\n[WIKIPEDIA SUMMARY]${NC}"
    curl -s "https://en.wikipedia.org/api/rest_v1/page/summary/$QUERY" |
    jq -r '.extract // "No summary found."'

    echo -e "${BLUE}\n[DUCKDUCKGO RESULTS]${NC}"
    curl -sG "https://api.duckduckgo.com" \
        --data-urlencode "q=$QUERY" --data "format=json" |
    jq -r '.RelatedTopics[].Text' 2>/dev/null | head -n 10
}

##############################################
#           ACTIVE STANDARD MODE
##############################################
active_standard() {
    TARGET="$1"
    echo -e "${YELLOW}[ACTIVE - STANDARD] Target: $TARGET${NC}"

    require "whois"
    require "dig"
    require "whatweb" "https://github.com/urbanadventurer/WhatWeb.git" "whatweb"

    echo -e "${BLUE}\n[WHOIS]${NC}"
    whois "$TARGET"

    echo -e "${BLUE}\n[DNS INFO]${NC}"
    dig "$TARGET" ANY +short

    echo -e "${BLUE}\n[WHATWEB]${NC}"
    whatweb "$TARGET"
}

##############################################
#                ACTIVE SAFE MODE
##############################################
active_safe() {
    TARGET="$1"
    echo -e "${CYAN}[ACTIVE - SAFE] Target: $TARGET${NC}"

    require "whois"
    require "dig"
    require "whatweb" "https://github.com/urbanadventurer/WhatWeb.git" "whatweb"

    whois "$TARGET"
    dig "$TARGET" ANY +short
    whatweb "$TARGET"
}

##############################################
#           ACTIVE RISKY MODE (FULL)
##############################################
active_risky() {
    TARGET="$1"
    echo -e "${RED}[ACTIVE - RISKY] Target: $TARGET${NC}"

    require "whois"
    require "dig"
    require "dnsenum" "https://github.com/fwaeytens/dnsenum.git" "dnsenum.pl"
    require "nmap"
    require "whatweb" "https://github.com/urbanadventurer/WhatWeb.git" "whatweb"

    echo -e "${BLUE}\n[WHOIS]${NC}"
    whois "$TARGET"

    echo -e "${BLUE}\n[DNS INFO]${NC}"
    dig "$TARGET" ANY +short

    echo -e "${BLUE}\n[DNSENUM]${NC}"
    dnsenum "$TARGET"

    echo -e "${BLUE}\n[WHATWEB]${NC}"
    whatweb "$TARGET"

    echo -e "${BLUE}\n[NMAP AGGRESSIVE]${NC}"
    sudo nmap -A "$TARGET"
}

##############################################
#                 ARGUMENT PARSER
##############################################
case "$1" in
    -p)
        passive "$2"
        ;;
    -a)
        active_standard "$2"
        ;;
    -aS)
        active_safe "$2"
        ;;
    -aR)
        active_risky "$2"
        ;;
    *)
        echo -e "${GREEN}Usage:"
        echo "  oSaint -p \"subject\"      : Passive OSINT"
        echo "  oSaint -a target.com      : Standard Active OSINT"
        echo "  oSaint -aS target.com     : Safe Mode (Low Noise)"
        echo "  oSaint -aR target.com     : Risky Mode (Full Scan)"
        echo
        exit
        ;;
esac
